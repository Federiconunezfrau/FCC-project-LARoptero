/*
 * system.h
 *
 *  Created on: Feb 2, 2024
 *      Author: fede
 */

#ifndef INC_SYSTEM_H_v
#define INC_SYSTEM_H_

#include "stateMachine.h"
#include "usart.h"
#include "utils.hpp"
#include "PCIFmsg.h"
#include "port.hpp"

#define SIZE_BUFFER_MSG_BUFFER 8

typedef struct
{
	stateMachine_t super;
	evBuffer *mEventQueue_;
	circ_buffer<uint8_t, SIZE_BUFFER_MSG_BUFFER> mRxBuffer_;
	circ_buffer<PCIFmsg_t, SIZE_BUFFER_MSG_BUFFER> mTxBuffer_;
	gpio *mLED_;
} system;

void    system_constructor    ( system*, evBuffer* );
state_t system_initial        ( system*, event_t const );
state_t system_idle           ( system*, event_t const );
state_t system_fail_safe_mode ( system*, event_t const );
state_t system_normal_mode    ( system*, event_t const );

uint8_t system_has_new_msg    ( system *);
void    system_update_uart    ( system *, uint8_t*, uint32_t );

#endif /* INC_SYSTEM_H_ */
